# `app.py` 重构设计文档

## 1. 概述

本文档旨在为 `app.py` 的重构提供详细的设计方案。重构的核心目标是将庞大的 `app.py` 文件拆分为多个功能内聚、高度解耦的模块，以提升代码的可读性、可维护性和可扩展性。本次重构将遵循需求文档中定义的所有规范，确保在不改变现有功能的前提下，优化项目结构。

## 2. 架构

重构将采用基于蓝图（Blueprint）的模块化架构。Flask 的蓝图机制允许我们将应用的功能划分为独立的组件，每个组件负责一部分特定的路由和逻辑。这种方式有助于组织代码、避免命名空间冲突，并使模块可重用。

新的项目结构将如下所示：

```
/Users/bytedance/python_src/ai-heli-v3/
├── .ug/
│   └── refactor/
│       ├── requirements.md
│       └── design.md
├── src/
│   ├── __init__.py       # 应用工厂和核心配置
│   ├── auth.py           # 认证蓝图（登录、注销、Token、CSRF）
│   ├── agents.py         # 代理商管理蓝图
│   ├── map_data.py       # 地图数据蓝图 (GeoJSON)
│   ├── models.py         # 数据模型（目前为内存用户数据）
│   └── utils.py          # 通用工具函数
├── run.py                # 应用启动脚本
├── static/
├── data/
└── ... (其他文件)
```

## 3. 组件与接口

### 3.1. `src/__init__.py` - 应用工厂

*   **组件**: 应用工厂函数 `create_app()`。
*   **职责**:
    *   创建并配置 Flask 应用实例 (`app`)。
    *   处理密钥、CORS、JSON编码等应用级配置。
    *   初始化并注册蓝图（`auth`, `agents`, `map_data`）。
    *   将原 `app.py` 中的全局配置（如 `login_attempts`）移入应用上下文中。
*   **接口**:
    *   `create_app()`: 返回一个配置完成的 Flask 应用实例。

### 3.2. `src/auth.py` - 认证模块

*   **组件**: `auth_bp` (蓝图)。
*   **职责**:
    *   定义 `/api/login`, `/api/logout`, `/api/csrf-token` 路由。
    *   实现用户登录、注销逻辑。
    *   包含 `token_required`, `optional_token`, `admin_required`, `limit_login_attempts` 等认证和授权装饰器。
    *   管理 CSRF 令牌的生成和验证。
    *   包含密码解密和验证逻辑。
*   **接口**: `auth_bp` 蓝图实例，供 `create_app` 注册。

### 3.3. `src/agents.py` - 代理商管理模块

*   **组件**: `agents_bp` (蓝图)。
*   **职责**:
    *   定义 `/api/agents`, `/api/county/<county_name>` 等与代理商数据相关的 CRUD 路由。
    *   实现从 CSV 文件加载、添加、更新和删除代理商数据的逻辑。
    *   处理管理员和普通用户的数据脱敏逻辑。
*   **接口**: `agents_bp` 蓝图实例，供 `create_app` 注册。

### 3.4. `src/map_data.py` - 地图数据模块

*   **组件**: `map_data_bp` (蓝图)。
*   **职责**:
    *   定义 `/api/geojson` 路由。
    *   提供 `中国_县.geojson` 数据。
*   **接口**: `map_data_bp` 蓝图实例，供 `create_app` 注册。

### 3.5. `src/models.py` - 数据模型

*   **组件**: 数据定义。
*   **职责**: 存放应用的数据模型。在当前阶段，这主要包括：
    *   `users` 字典：模拟的用户数据库。
    *   `salt` 和 `hashed_salted_password` 等与初始用户密码相关的变量。
*   **接口**: 导出 `users` 等变量供其他模块使用。

### 3.6. `src/utils.py` - 工具模块

*   **组件**: 工具函数。
*   **职责**: 存放与具体业务逻辑无关的通用函数，例如：
    *   `get_data_path()`: 获取资源文件路径的辅助函数。
*   **接口**: 导出 `get_data_path` 函数。

### 3.7. `run.py` - 启动脚本

*   **组件**: 应用启动入口。
*   **职责**:
    *   从 `src` 导入 `create_app` 工厂函数。
    *   创建应用实例。
    *   运行应用，并处理 SSL 上下文和启动异常。
*   **接口**: 无，作为应用的执行入口。

## 4. 数据模型

*   **用户数据**: 保持在 `src/models.py` 中的 `users` 字典结构不变，包含用户名、密码哈希、管理员状态等信息。
*   **代理商数据**: 保持从 `data/爱河狸数据_地址拆分.csv` 文件中读取和写入的逻辑不变，数据结构在 `load_agent_data` 函数中动态构建。
*   **登录尝试**: `login_attempts` 字典将作为应用配置的一部分，在 `create_app` 中初始化，并通过 `current_app` 在 `auth` 模块中访问。

## 5. 错误处理

*   现有的错误处理逻辑（如返回 JSON 格式的错误信息和正确的 HTTP 状态码）将保持不变。
*   每个蓝图将独立处理其内部的错误。
*   应用启动时的异常捕获逻辑将移至 `run.py`。

## 6. 测试策略

根据需求文档，本次重构的核心要求是保持功能不变。因此，测试策略将侧重于回归测试。

*   **手动验证**: 根据需求 `2.2.3`，在每个模块重构完成后，我将暂停执行，并向您提供明确的验证步骤，以便您手动检查该模块的功能是否正常。
*   **各模块验证**: 每个模块的验证步骤将独立进行，互不干扰。
*   **验证步骤示例**:
    1.  **启动应用**: 运行 `python run.py`。
    2.  **接口测试**: 使用 Postman 或 curl 等工具，针对已重构的路由（例如 `/api/login`）发送请求，并验证响应是否与重构前一致。
    3.  **前端交互**: 打开 `static/index.html`，执行相关操作（如登录、查看地图），确认功能正常。

在得到您的确认后，我才会继续进行下一个模块的重构。