# 后端重构方案

## 概述
当前 `app.py` 文件过于臃肿，包含约1000行代码，集成了认证、数据处理、路由等多个功能模块。为了提高代码的可维护性和可扩展性，需要对该文件进行模块化重构。

本方案旨在将 `app.py` 中的不同功能模块拆分为独立的Python文件，每个文件负责特定的功能，遵循高内聚低耦合的设计原则。

## 重构目标
1. 将 `app.py` 文件中的功能模块拆分为多个独立的模块文件
2. 保持原有功能不变，确保重构后系统正常运行
3. 提高代码可读性、可维护性和可扩展性
4. 每次只重构一个模块，用户确认无误后再进行下一个模块的重构

## 重构计划

### 第一步：认证模块拆分
**涉及功能：**
- 用户认证相关功能（登录、登出、令牌生成与验证）
- 密码处理相关函数
- CSRF令牌处理函数
- 装饰器函数（token_required, optional_token, admin_required, limit_login_attempts）

**拆分文件：**
- 创建 `src/auth.py` 文件
- 将认证相关代码从 `app.py` 移动到 `src/auth.py`
- 在 `app.py` 中导入认证模块

**验证点：**
- 用户登录功能正常
- 用户登出功能正常
- 令牌生成与验证功能正常
- CSRF保护功能正常
- 管理员权限验证功能正常

### 第二步：数据处理模块拆分
**涉及功能：**
- 县总代数据加载函数
- CSV数据读取与处理
- GB代码数据处理

**拆分文件：**
- 创建 `src/data_handler.py` 文件
- 将数据处理相关代码从 `app.py` 移动到 `src/data_handler.py`
- 在 `app.py` 中导入数据处理模块

**验证点：**
- 县总代数据加载功能正常
- 数据脱敏功能正常
- CSV文件读取与处理功能正常

### 第三步：路由模块拆分
**涉及功能：**
- 所有API路由定义
- 路由处理函数

**拆分文件：**
- 创建 `src/routes.py` 文件
- 将路由相关代码从 `app.py` 移动到 `src/routes.py`
- 在 `app.py` 中导入路由模块

**验证点：**
- 所有API接口功能正常
- 路由访问正常

### 第四步：配置模块拆分
**涉及功能：**
- 应用配置相关代码
- 密钥生成与管理
- 环境变量处理

**拆分文件：**
- 创建 `src/config.py` 文件
- 将配置相关代码从 `app.py` 移动到 `src/config.py`
- 在 `app.py` 中导入配置模块

**验证点：**
- 应用配置加载正常
- 密钥生成与管理功能正常
- 环境变量处理功能正常

### 第五步：主应用模块优化
**涉及功能：**
- Flask应用实例化
- 主函数启动逻辑

**优化文件：**
- 保留核心应用初始化代码在 `app.py`
- 移除冗余代码
- 优化模块导入顺序

**验证点：**
- 应用启动正常
- HTTPS配置正常
- 静态文件服务正常

## 重构原则
1. 每次只重构一个模块，确保用户确认后再进行下一步
2. 保持原有接口不变，确保前后端兼容性
3. 添加适当的注释和文档
4. 遵循PEP8代码规范
5. 确保错误处理机制完整

## 验证流程
1. 每个模块重构完成后，进行单元测试
2. 用户手动验证关键功能
3. 确认无误后进行下一个模块的重构
4. 最终进行全面回归测试

## 风险控制
1. 重构前备份原始文件
2. 保持Git版本控制
3. 出现问题时可快速回滚
4. 每个步骤都有明确的验证点